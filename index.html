<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Carga</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #005A9C; --secondary-color: #f4f4f4; --success-color: #28a745;
            --danger-color: #dc3545; --text-color: #333; --light-green: #d4edda; --light-red: #f8d7da;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--secondary-color); color: var(--text-color); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
        .hidden { display: none !important; }
        main { width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card h1, .card h2 { margin-top: 0; color: var(--primary-color); }
        .app-header { display: flex; justify-content: space-between; align-items: center; }
        #login-screen { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; }
        .login-container { text-align: center; width: 90%; max-width: 400px; }
        .login-container input { width: 100%; padding: 12px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .login-container button { width: 100%; margin-top: 20px; padding: 12px; border: none; border-radius: 5px; color: white; font-weight: bold; font-size: 1.1em; cursor: pointer; background-color: var(--success-color); }
        #login-error { color: var(--danger-color); margin-top: 15px; }
        .logout-button { background-color: var(--danger-color); font-size: 0.9em; padding: 8px 12px; border: none; color: white; border-radius: 5px; cursor: pointer; }
        #reset-data-button { background-color: #6c757d; margin-top: 15px; }
        #scanner-controls { text-align: center; margin-top: 15px; display: flex; gap: 10px; justify-content: center; }
        #scanner-controls button { padding: 12px 15px; border: none; background-color: var(--primary-color); color: white; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; flex-grow: 1; }
        #scanner-controls button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #qr-reader { width: 100%; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        #qr-reader-placeholder { width: 100%; aspect-ratio: 1/1; background-color: #e9ecef; display: flex; justify-content: center; align-items: center; color: #6c757d; font-size: 1.2em; border-radius: 8px; text-align: center; border: 2px dashed #ced4da; }
        #scan-result { margin-top: 15px; font-weight: bold; padding: 12px; border-radius: 5px; width: 100%; box-sizing: border-box; text-align: center; }
        .result-success { color: #155724; background-color: var(--light-green); border: 1px solid #c3e6cb; }
        .result-error { color: #721c24; background-color: var(--light-red); border: 1px solid #f5c6cb; }
        .result-info { color: #0c5460; background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .progress-bar-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; margin-bottom: 15px; position: relative; height: 30px; display: flex; align-items: center; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--success-color); border-radius: 5px; transition: width 0.4s ease; }
        #progressText { position: absolute; width: 100%; text-align: center; font-weight: bold; color: #000; text-shadow: 0 0 2px white; }
        #full-route-list { margin-top: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; }
        .route-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .status-indicator { width: 25px; height: 25px; border-radius: 50%; background-color: #ccc; flex-shrink: 0; margin-left: 15px; }
        .status-indicator.scanned { background-color: var(--success-color); background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/></svg>'); background-position: center; background-repeat: no-repeat; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; text-align: center; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .file-input-wrapper { margin: 20px 0; }
        .file-input-wrapper input[type="file"] { display: none; }
        .file-input-label { background-color: var(--primary-color); color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: inline-block; }
        #pdf-filename { margin-left: 10px; color: #555; }
        #admin-results ul { list-style-type: none; padding: 0; text-align: left;}
        #admin-results li { background: #e9e9e9; margin: 5px 0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="card login-container"><h1>Verificador de Carga</h1><p>Entre com seu usu√°rio e senha.</p><input type="text" id="username" placeholder="Usu√°rio" autocomplete="username"><input type="password" id="password" placeholder="Senha" autocomplete="current-password"><button id="loginButton">Entrar</button><p id="login-error" class="hidden">Usu√°rio ou senha inv√°lidos.</p></div>
    </div>
    <main id="app" class="hidden">
        <div class="card app-header"><h2 id="welcomeMessage"></h2><button class="logout-button">Sair</button></div>
        <div class="card" id="scanner-section"><div id="qr-reader"><div id="qr-reader-placeholder">A c√¢mera aparecer√° aqui</div></div><div id="scanner-controls"><button id="startScanButton">üì∑ Iniciar Leitura</button><button id="manualEntryButton">‚å®Ô∏è Digitar C√≥digo</button></div><p id="scan-result"></p></div>
        <div class="card" id="route-list-section"><div class="app-header"><h2>Pacotes da Rota</h2><button id="toggle-list-button">Esconder</button></div><div class="progress-bar-container"><div class="progress-bar" id="progressBar"></div><span id="progressText">0%</span></div><div id="full-route-list"></div></div>
    </main>
    <main id="admin-app" class="hidden">
        <div class="card app-header"><h2 id="adminWelcomeMessage">Painel do Administrador</h2><button class="logout-button">Sair</button></div>
        <div class="card">
            <h3>Distribui√ß√£o de Rotas</h3><p>Carregue o arquivo PDF de rotas para distribuir aos motoristas.</p>
            <div class="file-input-wrapper"><label for="pdf-upload" class="file-input-label">Escolher Arquivo PDF</label><input type="file" id="pdf-upload" accept="application/pdf"><span id="pdf-filename">Nenhum arquivo selecionado</span></div>
            <button id="process-pdf-button" disabled>Processar e Distribuir</button>
            <div id="admin-results" style="margin-top: 20px;"></div>
            <hr style="margin: 25px 0 15px;">
            <p><small>Para come√ßar um novo teste do zero, limpe os dados salvos.</small></p>
            <button id="reset-data-button" class="logout-button">Resetar Sistema</button>
        </div>
    </main>
    <div id="manualEntryModal" class="modal"><div class="modal-content"><span class="close-button">√ó</span><h3>Digitar C√≥digo do Pacote</h3><input type="text" id="manualCodeInput" placeholder="Insira o c√≥digo aqui..."><button id="submitManualCode">Verificar C√≥digo</button></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
            
            const initialDatabaseState = {
                users: {"admin":{password:"admin",name:"Administrador",isAdmin:true},"joao.silva":{password:"123",name:"Jo√£o Silva",isAdmin:false},"maria.souza":{password:"456",name:"Maria Souza",isAdmin:false},"motorista3":{password:"789",name:"Carlos Pereira",isAdmin:false}},
                routes: {"joao.silva":[],"maria.souza":[],"motorista3":[]}
            };

            // --- L√ìGICA DE PERSIST√äNCIA DE DADOS ---
            let fakeDatabase;
            const storedDb = localStorage.getItem('fakeDatabase');
            if (storedDb) {
                fakeDatabase = JSON.parse(storedDb);
                console.log("Banco de dados carregado da localStorage.");
            } else {
                fakeDatabase = JSON.parse(JSON.stringify(initialDatabaseState));
                console.log("Banco de dados inicializado a partir do estado padr√£o.");
            }
            // ------------------------------------

            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app');
            const adminScreen = document.getElementById('admin-app');
            const loginButton = document.getElementById('loginButton');
            const loginError = document.getElementById('login-error');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const adminWelcomeMessage = document.getElementById('adminWelcomeMessage');
            const pdfUpload = document.getElementById('pdf-upload');
            const pdfFilename = document.getElementById('pdf-filename');
            const processPdfButton = document.getElementById('process-pdf-button');
            const adminResults = document.getElementById('admin-results');
            const startScanButton = document.getElementById('startScanButton');
            const resetDataButton = document.getElementById('reset-data-button');
            
            let routeData = [];
            let html5QrCode;
            let isScanCooldown = false;
            let audioContext = null;

            document.querySelectorAll('.logout-button').forEach(btn => btn.addEventListener('click', handleLogout));
            loginButton.addEventListener('click', handleLogin);
            resetDataButton.addEventListener('click', handleResetSystem);
            document.getElementById('password').addEventListener('keyup', (e) => { if (e.key === 'Enter') handleLogin(); });
            
            function initAudioContext() {
                if (!audioContext && (window.AudioContext || window.webkitAudioContext)) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }
            function playSound(type) {
                if (!audioContext) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                if (type === 'success') {
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                } else { // error
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                }
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            function handleLogin() {
                initAudioContext();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                const user = fakeDatabase.users[username];

                if (user && user.password === password) {
                    loginScreen.classList.add('hidden');
                    loginError.classList.add('hidden');
                    if (user.isAdmin) {
                        adminWelcomeMessage.textContent = `Bem-vindo, ${user.name}`;
                        adminScreen.classList.remove('hidden');
                    } else {
                        welcomeMessage.textContent = `Bem-vindo, ${user.name}!`;
                        appScreen.classList.remove('hidden');
                        loadUserRoute(username);
                    }
                } else {
                    playSound('error');
                    loginError.classList.remove('hidden');
                }
            }
            
            function handleLogout() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error(err));
                }
                // Esta fun√ß√£o agora apenas esconde as telas. Os dados persistem.
                adminScreen.classList.add('hidden');
                appScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }

            function handleResetSystem() {
                if (confirm("Voc√™ tem certeza que deseja apagar todas as rotas distribu√≠das?")) {
                    localStorage.removeItem('fakeDatabase');
                    console.log("localStorage foi limpo.");
                    alert("Sistema resetado com sucesso!");
                    location.reload(); // Recarrega a p√°gina para um estado inicial limpo.
                }
            }

            pdfUpload.addEventListener('change', () => {
                if (pdfUpload.files.length > 0) {
                    pdfFilename.textContent = pdfUpload.files[0].name;
                    processPdfButton.disabled = false;
                } else {
                    pdfFilename.textContent = 'Nenhum arquivo selecionado';
                    processPdfButton.disabled = true;
                }
            });

            processPdfButton.addEventListener('click', async () => {
                const file = pdfUpload.files[0];
                if (!file) return;
                adminResults.innerHTML = '<p>Processando PDF... Por favor, aguarde.</p>';
                processPdfButton.disabled = true;

                try {
                    const allText = await extractTextFromPdf(file);
                    const parsedRoutes = parseRoutesFromText(allText);
                    distributeRoutes(parsedRoutes);
                } catch (error) {
                    adminResults.innerHTML = `<p class="result-error">Erro ao processar o PDF: ${error.message}</p>`;
                } finally {
                    processPdfButton.disabled = false;
                }
            });
            
            function extractTextFromPdf(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const pdf = await pdfjsLib.getDocument(event.target.result).promise;
                            let allText = '';
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                allText += textContent.items.map(item => item.str).join(' ');
                            }
                            resolve(allText);
                        } catch (err) { reject(err); }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }

            function parseRoutesFromText(text) {
                const routes = {};
                const lineRegex = /SSP16\s+(PM\d+_?\d+)\s+#N\/A\s+#N\/A\s+([\dA-Z]+)\s+(\d{11,})\s+Parati/g;
                let match;
                while ((match = lineRegex.exec(text)) !== null) {
                    const routeName = match[1];
                    const order = match[2];
                    const shipmentCode = match[3];
                    if (!routes[routeName]) routes[routeName] = [];
                    routes[routeName].push({
                        id: `item-${shipmentCode}`,
                        ordem_parada: order,
                        produto_codigo: shipmentCode,
                        endereco: 'Endere√ßo n√£o dispon√≠vel no PDF',
                        referencias: 'N/A',
                        scanned: false
                    });
                }
                return routes;
            }

            function distributeRoutes(parsedRoutes) {
                Object.keys(fakeDatabase.routes).forEach(driver => fakeDatabase.routes[driver] = []);
                let resultsHtml = '<h3>Distribui√ß√£o Conclu√≠da</h3><ul>';

                if(parsedRoutes['PM299_1']) {
                    fakeDatabase.routes['joao.silva'] = parsedRoutes['PM299_1'];
                    resultsHtml += `<li><b>PM299_1</b> (${parsedRoutes['PM299_1'].length} pacotes) foi atribu√≠da a <b>joao.silva</b>.</li>`;
                }
                if(parsedRoutes['PM2_3']) {
                    fakeDatabase.routes['maria.souza'] = parsedRoutes['PM2_3'];
                    resultsHtml += `<li><b>PM2_3</b> (${parsedRoutes['PM2_3'].length} pacotes) foi atribu√≠da a <b>maria.souza</b>.</li>`;
                }
                
                // Salva o banco de dados atualizado na localStorage.
                localStorage.setItem('fakeDatabase', JSON.stringify(fakeDatabase));
                console.log("Banco de dados atualizado e salvo na localStorage.");

                resultsHtml += '</ul><p><b>Os dados da rota foram salvos.</b></p>';
                adminResults.innerHTML = resultsHtml;
            }

            startScanButton.addEventListener('click', startScanner);

            function loadUserRoute(username) {
                routeData = fakeDatabase.routes[username] || [];
                html5QrCode = new Html5Qrcode("qr-reader");
                renderFullList();
                updateProgress();
            }
            
            function validateCode(code) {
                if (isScanCooldown) return;
                isScanCooldown = true;
                setTimeout(() => { isScanCooldown = false; }, 1500);

                const foundItem = routeData.find(item => item.produto_codigo === code);
                if (foundItem) {
                    if (!foundItem.scanned) {
                        foundItem.scanned = true;
                        playSound('success');
                        displayFeedback(`C√≥digo ${code} OK!`, "success");
                        const itemElement = document.getElementById(foundItem.id);
                        if(itemElement) itemElement.querySelector('.status-indicator').classList.add('scanned');
                        updateProgress();
                    } else {
                        playSound('error');
                        displayFeedback(`C√≥digo ${code} j√° foi verificado.`, "info");
                    }
                } else {
                    playSound('error');
                    displayFeedback(`ERRO: C√≥digo ${code} n√£o pertence a esta rota!`, "error");
                }
            }
            
            function startScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        startScanButton.textContent = "üì∑ Iniciar Leitura";
                        document.getElementById('qr-reader-placeholder').style.display = 'flex';
                    }).catch(err => console.error(err));
                    return;
                }
                document.getElementById('qr-reader-placeholder').style.display = 'none';
                startScanButton.disabled = true;
                startScanButton.textContent = "Carregando...";
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => validateCode(decodedText))
                .then(() => {
                    startScanButton.disabled = false;
                    startScanButton.textContent = "Parar Leitura";
                }).catch(err => {
                    alert(`Erro ao iniciar a c√¢mera: ${err}. Verifique as permiss√µes.`);
                    startScanButton.disabled = false;
                    startScanButton.textContent = "üì∑ Iniciar Leitura";
                    document.getElementById('qr-reader-placeholder').style.display = 'flex';
                });
            }
            
            const manualEntryButton = document.getElementById('manualEntryButton');
            const manualEntryModal = document.getElementById('manualEntryModal');
            const closeModalButton = document.querySelector('.close-button');
            const submitManualCode = document.getElementById('submitManualCode');
            const toggleListButton = document.getElementById('toggle-list-button');
            manualEntryButton.addEventListener('click', () => manualEntryModal.style.display = 'block');
            closeModalButton.addEventListener('click', () => manualEntryModal.style.display = 'none');
            submitManualCode.addEventListener('click', processManualCode);
            toggleListButton.addEventListener('click', toggleRouteList);
            window.addEventListener('click', (event) => { if (event.target == manualEntryModal) manualEntryModal.style.display = 'none'; });
            function renderFullList() { const listDiv = document.getElementById('full-route-list'); listDiv.innerHTML = ''; if (!routeData || routeData.length === 0) { listDiv.innerHTML = "<p style='padding: 15px; text-align: center;'>Nenhuma rota atribu√≠da.</p>"; return; } routeData.forEach(item => { const itemDiv = document.createElement('div'); itemDiv.className = 'route-item'; itemDiv.id = item.id; const itemInfo = document.createElement('div'); itemInfo.className = 'item-info'; itemInfo.innerHTML = `<p><strong>Parada ${item.ordem_parada}:</strong> ${item.endereco}</p><p><small>C√≥digo: ${item.produto_codigo} | Ref: ${item.referencias}</small></p>`; const statusIndicator = document.createElement('div'); statusIndicator.className = 'status-indicator'; if (item.scanned) statusIndicator.classList.add('scanned'); itemDiv.appendChild(itemInfo); itemDiv.appendChild(statusIndicator); listDiv.appendChild(itemDiv); }); }
            function updateProgress() { const bar = document.getElementById('progressBar'); const text = document.getElementById('progressText'); const sButton = document.getElementById('startScanButton'); const mButton = document.getElementById('manualEntryButton'); if (!routeData || routeData.length === 0) { bar.style.width = '0%'; text.textContent = 'Nenhuma Rota'; sButton.disabled = true; mButton.disabled = true; return; } sButton.disabled = false; mButton.disabled = false; const scannedCount = routeData.filter(item => item.scanned).length; const percentage = Math.round((scannedCount / routeData.length) * 100); bar.style.width = `${percentage}%`; text.textContent = `${percentage}% (${scannedCount} de ${routeData.length})`; if (percentage === 100) { displayFeedback("üéâ Carga Completa!", "success", false); if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => console.error(err)); sButton.textContent = "Carga Verificada"; document.getElementById('qr-reader-placeholder').style.display = 'flex'; } sButton.disabled = true; } }
            function processManualCode() { const input = document.getElementById('manualCodeInput'); const code = input.value.trim(); if (code) { validateCode(code); input.value = ''; manualEntryModal.style.display = 'none'; } }
            document.getElementById('manualCodeInput').addEventListener('keyup', (e) => { if(e.key === 'Enter') processManualCode(); });
            const scanResultEl = document.getElementById('scan-result');
            function displayFeedback(message, type, autoClear = true) { scanResultEl.innerHTML = message; scanResultEl.className = `result-${type}`; if (autoClear) { setTimeout(() => { scanResultEl.innerHTML = ''; scanResultEl.className = ''; }, 4000); } }
            function toggleRouteList() { const listDiv = document.getElementById('full-route-list'); const isHidden = listDiv.classList.toggle('hidden'); toggleListButton.textContent = isHidden ? 'Mostrar Lista' : 'Esconder'; }
        });
    </script>
</body>
</html>
