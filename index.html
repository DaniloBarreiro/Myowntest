<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contador de Produtos - Transportadora</title>
  <script src="https://unpkg.com/@zxing/library@0.18.6/umd/index.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    /* … todo o seu CSS inalterado … */
  </style>
</head>

<body>
  <div id="toast" class="toast"></div>

  <div class="container">
    <header class="text-center">
      <h1>📱 Inventário Mobile V1</h1>
      <p class="subtitle">Escaneie produtos para verificar a carga</p>
    </header>

    <section>
      <label for="csvInput" class="block">Carregar Lista CSV</label>
      <input id="csvInput" type="file" accept=".csv" />
      <p class="text-sm">Formato esperado: Código,Nome,Quantidade (uma linha por produto)</p>
    </section>

    <section>
      <div class="flex justify-between mb-4">
        <button id="startCamera" class="btn-primary">📷 Iniciar Câmera</button>
        <button id="takePhoto" class="btn-success hidden">📸 Ler Código</button>
        <button id="stopCamera" class="btn-danger hidden">⏹️ Parar Câmera</button>
      </div>
      <div id="videoContainer" class="hidden">
        <video id="video" muted playsinline></video>
        <div class="camera-overlay"></div>
      </div>
      <div class="flex items-center">
        <input id="barcodeInput" type="text" placeholder="Código de Barras (Manual)"
          onkeypress="if(event.key === 'Enter') document.getElementById('addProduct').click()" />
        <button id="addProduct" class="btn-success ml-2">➕ Adicionar</button>
      </div>
    </section>

    <section>
      <h2>Progresso da Verificação</h2>
      <div class="progress-container">
        <div id="progressBar" class="progress-bar" style="width: 0%"></div>
      </div>
      <p class="text-sm"><span id="progressPercent">0%</span> concluído (<span id="foundCount">0</span>/<span
          id="totalCount">0</span>)</p>
      <div class="stats-grid">
        <div>
          <p class="stat-value"><span id="scannedCount">0</span></p>
          <p>Escaneados</p>
        </div>
        <div>
          <p class="stat-value"><span id="expectedCount">0</span></p>
          <p>Esperados</p>
        </div>
        <div>
          <p class="stat-value"><span id="okCount">0</span> ✓</p>
          <p>OK</p>
        </div>
        <div>
          <p class="stat-value"><span id="problemCount">0</span> ⚠️</p>
          <p>Problemas</p>
        </div>
      </div>
    </section>

    <section>
      <h2>📦 Produtos</h2>
      <div id="noProducts" class="text-center py-4">
        <p class="text-xl">📦</p>
        <p>Carregue um CSV e escaneie os produtos!</p>
      </div>
      <ul id="productList" class="hidden"></ul>
    </section>

    <section class="actions-container flex justify-between gap-2">
      <button id="loadTestData" class="btn-warning">📊 Carregar Dados Teste</button>
      <button id="exportImage" class="btn-secondary">🖼️ Exportar Relatório</button>
      <button id="clearAll" class="btn-danger">🗑️ Limpar Tudo</button>
    </section>
  </div>

  <script>
    const state = {
      products: JSON.parse(localStorage.getItem('products')) || [],
      scannedProducts: JSON.parse(localStorage.getItem('scannedProducts')) || [],
      codeReader: null,
      audioContext: null,
      currentStream: null
    };

    document.addEventListener('DOMContentLoaded', () => {
      initEventListeners();
      updateProductList();
    });

    function initEventListeners() {
      document.getElementById('csvInput').addEventListener('change', handleCsvUpload);
      document.getElementById('loadTestData').addEventListener('click', loadTestData);
      document.getElementById('startCamera').addEventListener('click', startCamera);
      document.getElementById('takePhoto').addEventListener('click', takePhotoAndScan);
      document.getElementById('stopCamera').addEventListener('click', stopCamera);
      document.getElementById('addProduct').addEventListener('click', addProductManually);
      document.getElementById('exportImage').addEventListener('click', exportAsImage);
      document.getElementById('clearAll').addEventListener('click', clearAll);
    }

    function handleCsvUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        state.products = parseCsv(e.target.result);
        state.scannedProducts = [];
        saveState();
        updateProductList();
      };
      reader.readAsText(file);
    }

    function parseCsv(text) {
      return text.split('\n')
        .slice(1)
        .map(line => {
          const [code, name, expectedQty] = line.split(',');
          return {
            code: (code || '').trim(),
            name: (name || '').trim(),
            expectedQty: parseInt(expectedQty) || 1,
            scannedQty: 0
          };
        })
        .filter(p => p.code && p.name);
    }

    function loadTestData() {
      const testData = `code,name,expectedQty
123456789012,Produto A,5
987654321098,Produto B,3
456789123456,Produto C,2
789123456789,Produto D,1
321654987321,Produto E,4`;
      state.products = parseCsv(testData);
      state.scannedProducts = [];
      saveState();
      updateProductList();
      showToast('Dados de teste carregados com sucesso');
    }

    async function startCamera() {
      try {
        const video = document.getElementById('video');
        document.getElementById('videoContainer').classList.remove('hidden');
        document.getElementById('startCamera').classList.add('hidden');
        document.getElementById('takePhoto').classList.remove('hidden');
        document.getElementById('stopCamera').classList.remove('hidden');

        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        video.srcObject = stream;
        state.currentStream = stream;
        await video.play();

        state.codeReader = new ZXing.BrowserMultiFormatReader();
        showToast('Câmera iniciada. Clique em "Ler Código"');
      } catch (error) {
        console.error('Erro ao acessar a câmera:', error);
        showToast('Erro ao acessar a câmera. Verifique as permissões.');
        stopCamera();
      }
    }

    async function takePhotoAndScan() {
      const video = document.getElementById('video');
      if (video.readyState !== HTMLMediaElement.HAVE_ENOUGH_DATA) {
        showToast('Câmera ainda não está pronta.');
        return;
      }

      try {
        showToast('Lendo código…');
        const result = await state.codeReader.decodeOnceFromVideoElement(video);
        handleScannedCode(result.text);
      } catch (error) {
        console.error('Erro na leitura:', error);
        showToast('Nenhum código válido encontrado.');
        playErrorSound();
        navigator.vibrate?.([100, 50, 100]);
      }
    }

    function stopCamera() {
      state.codeReader?.reset();
      state.codeReader = null;

      if (state.currentStream) {
        state.currentStream.getTracks().forEach(t => t.stop());
        state.currentStream = null;
      }
      document.getElementById('video').srcObject = null;
      document.getElementById('videoContainer').classList.add('hidden');
      document.getElementById('startCamera').classList.remove('hidden');
      document.getElementById('takePhoto').classList.add('hidden');
      document.getElementById('stopCamera').classList.add('hidden');
      showToast('Câmera parada.');
    }

    function addProductManually() {
      const code = document.getElementById('barcodeInput').value.trim();
      if (!code) return;
      handleScannedCode(code);
      document.getElementById('barcodeInput').value = '';
    }

    function handleScannedCode(code) {
      const product = state.products.find(p => p.code === code);
      if (!product) {
        playErrorSound();
        showToast('⚠️ Produto não encontrado na lista');
        navigator.vibrate?.([100, 50, 100]);
        return;
      }
      if (product.scannedQty >= product.expectedQty) {
        showToast(`❌ ${product.name} já completado (${product.scannedQty}/${product.expectedQty})`);
        playErrorSound();
        navigator.vibrate?.([100, 50, 100]);
        return;
      }
      product.scannedQty++;
      state.scannedProducts.push(code);
      saveState();
      updateProductList();
      playBeep();
      if (product.scannedQty === product.expectedQty) {
        showToast(`✅ ${product.name} completado (${product.scannedQty}/${product.expectedQty})`);
      }
    }

    function updateProductList() {
      const ul = document.getElementById('productList');
      const no = document.getElementById('noProducts');

      const totalQty = state.products.reduce((s, p) => s + p.expectedQty, 0);
      const scannedQty = state.products.reduce((s, p) => s + p.scannedQty, 0);
      const okCount = state.products.filter(p => p.scannedQty === p.expectedQty).length;
      const problemCount = state.products.filter(p => p.scannedQty !== p.expectedQty).length;
      const percent = totalQty ? Math.round(scannedQty / totalQty * 100) : 0;

      if (state.products.length) {
        no.classList.add('hidden');
        ul.classList.remove('hidden');
        ul.innerHTML = state.products.map(p => {
          const complete = p.scannedQty === p.expectedQty;
          const over = p.scannedQty > p.expectedQty;
          const under = p.scannedQty < p.expectedQty;
          let cls = 'status-ok', icon = '✓ (Completo)';
          if (over) { cls = 'status-warning'; icon = '⚠️ (Excesso)'; }
          if (under) { cls = 'status-error'; icon = '⚠️ (Faltando)'; }
          return `
            <li class="${complete ? 'product-complete' : ''}">
              <div class="product-info">
                <div class="product-name">${p.name}</div>
                <div class="product-code">${p.code}</div>
              </div>
              <span class="product-status ${cls}">
                ${p.scannedQty}/${p.expectedQty} ${icon}
              </span>
            </li>
          `;
        }).join('');
      } else {
        no.classList.remove('hidden');
        ul.classList.add('hidden');
      }

      document.getElementById('scannedCount').textContent = scannedQty;
      document.getElementById('expectedCount').textContent = totalQty;
      document.getElementById('okCount').textContent = okCount;
      document.getElementById('problemCount').textContent = problemCount;
      document.getElementById('foundCount').textContent = scannedQty;
      document.getElementById('totalCount').textContent = totalQty;
      const bar = document.getElementById('progressBar');
      bar.style.width = `${percent}%`;
      document.getElementById('progressPercent').textContent = `${percent}%`;
      bar.className = 'progress-bar';
      if (percent === 100 && problemCount === 0) bar.classList.add('bg-green-500');
      else if (percent === 100) bar.classList.add('bg-yellow-500');
      else bar.classList.add('bg-red-500');
    }

    function saveState() {
      localStorage.setItem('products', JSON.stringify(state.products));
      localStorage.setItem('scannedProducts', JSON.stringify(state.scannedProducts));
    }

    async function exportAsImage() {
      if (!state.products.length) { showToast('Nenhum produto carregado para exportar'); return; }
      try {
        showToast('Gerando imagem…');
        const exportEl = document.createElement('div');
        exportEl.style = 'background:white;padding:20px;border-radius:8px;max-width:800px;margin:0 auto;';
        const h1 = document.createElement('h1');
        h1.textContent = 'Relatório de Inventário';
        h1.style = 'text-align:center;margin-bottom:16px;font-size:1.5rem;';
        exportEl.appendChild(h1);
        const pDate = document.createElement('p');
        pDate.textContent = new Date().toLocaleString();
        pDate.style = 'text-align:center;margin-bottom:24px;color:#666;';
        exportEl.appendChild(pDate);
        const progSec = document.querySelector('section:nth-of-type(3)').cloneNode(true);
        progSec.style.marginBottom = '24px';
        exportEl.appendChild(progSec);
        const listClone = document.getElementById('productList').cloneNode(true);
        listClone.style.maxHeight = 'none';
        listClone.style.overflow = 'visible';
        exportEl.appendChild(listClone);
        document.body.appendChild(exportEl);
        const canvas = await html2canvas(exportEl, { scale: 2, logging: false, useCORS: true });
        document.body.removeChild(exportEl);
        const link = document.createElement('a');
        link.download = `inventario_${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showToast('Imagem exportada com sucesso');
      } catch (err) {
        console.error(err);
        showToast('Erro ao gerar imagem');
      }
    }

    function clearAll() {
      if (confirm('Tem certeza que deseja limpar todos os dados?')) {
        stopCamera();
        state.products = [];
        state.scannedProducts = [];
        localStorage.removeItem('products');
        localStorage.removeItem('scannedProducts');
        document.getElementById('csvInput').value = '';
        document.getElementById('barcodeInput').value = '';
        updateProductList();
        showToast('Todos os dados foram limpos');
      }
    }

    function playBeep() {
      if (!state.audioContext) state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const osc = state.audioContext.createOscillator();
      const gain = state.audioContext.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(800, state.audioContext.currentTime);
      gain.gain.setValueAtTime(1, state.audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, state.audioContext.currentTime + 0.3);
      osc.connect(gain);
      gain.connect(state.audioContext.destination);
      osc.start();
      osc.stop(state.audioContext.currentTime + 0.3);
    }

    function playErrorSound() {
      if (!state.audioContext) state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const osc = state.audioContext.createOscillator();
      const gain = state.audioContext.createGain();
      osc.type = 'square';
      osc.frequency.setValueAtTime(300, state.audioContext.currentTime);
      gain.gain.setValueAtTime(1, state.audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, state.audioContext.currentTime + 0.5);
      osc.connect(gain);
      gain.connect(state.audioContext.destination);
      osc.start();
      osc.stop(state.audioContext.currentTime + 0.5);
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>

</html>
